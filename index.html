<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>ÌïòÏõê ÌîΩÏóÖ Ïä§ÏºÄÏ§ÑÎü¨</title>
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg: #f8f6f1;
  --card: #ffffff;
  --primary: #7c9eb2;
  --primary-light: #d4e4ed;
  --accent: #e8a87c;
  --accent-light: #fae0d0;
  --text: #4a4a4a;
  --text-light: #8a8a8a;
  --border: #e8e4df;
  --shadow: 0 2px 8px rgba(0,0,0,0.06);
  --radius: 12px;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  -webkit-tap-highlight-color: transparent;
}
button, .child-chip, .day-toggle, .add-block-btn, .schedule-block {
  touch-action: manipulation;
}

/* Header */
.app-header {
  background: linear-gradient(135deg, var(--primary), #6b8fa3);
  color: white;
  padding: 16px 20px;
  display: flex;
  align-items: center;
  justify-content: center;
  position: sticky;
  top: 0;
  z-index: 100;
  box-shadow: 0 2px 12px rgba(124,158,178,0.3);
}
.app-header h1 { font-size: 18px; font-weight: 600; letter-spacing: -0.3px; }
.header-export-btn {
  position: absolute;
  right: 16px;
  background: rgba(255,255,255,0.2);
  border: none; color: white;
  width: 36px; height: 36px;
  border-radius: 50%; font-size: 16px;
  cursor: pointer;
  display: none; align-items: center; justify-content: center;
  transition: background 0.2s;
}
.header-export-btn:hover { background: rgba(255,255,255,0.3); }
.header-export-btn.visible { display: flex; }

/* Column Layout */
.schedule-container { padding: 8px 4px; }

.schedule-columns {
  display: grid;
  gap: 0;
  min-width: 100%;
  align-items: start;
}

.day-column {
  border-right: 1px solid var(--border);
  min-height: 120px;
}
.day-column:last-child { border-right: none; }

.day-header {
  text-align: center;
  padding: 12px 4px;
  font-size: 14px;
  font-weight: 700;
  color: var(--text);
  border-bottom: 2px solid var(--border);
  background: var(--bg);
  position: sticky;
  top: 54px;
  z-index: 10;
}

.day-body {
  display: flex;
  flex-direction: column;
  gap: 4px;
  padding: 4px 2px;
  min-height: 60px;
}

.day-body.drag-over {
  background: rgba(212,228,237,0.3);
  border-radius: 8px;
}

/* Empty State */
.empty-state {
  grid-column: 1 / -1;
  text-align: center;
  padding: 40px 20px;
  color: var(--text-light);
}
.empty-state svg { width: 64px; height: 64px; margin-bottom: 12px; opacity: 0.35; }
.empty-state p { font-size: 13px; line-height: 1.6; }

/* Schedule Block */
.schedule-block {
  background: var(--card);
  border-radius: 10px;
  padding: 10px 8px;
  box-shadow: var(--shadow);
  cursor: grab;
  transition: transform 0.15s, box-shadow 0.15s;
  position: relative;
  display: flex;
  align-items: center;
  gap: 5px;
  overflow: hidden;
}
.block-color-bar {
  position: absolute;
  left: 0; top: 0; bottom: 0;
  width: 4px;
  flex-shrink: 0;
}
.schedule-block:active {
  cursor: grabbing;
  transform: scale(1.03);
  box-shadow: 0 4px 16px rgba(0,0,0,0.12);
}
.schedule-block.dragging {
  opacity: 0.4;
  transform: scale(0.95);
}

.block-route {
  flex: 1; min-width: 0;
  display: flex; flex-direction: column; gap: 1px;
}
.block-route-top {
  display: flex; align-items: baseline; gap: 3px;
}
.block-from {
  font-weight: 700; font-size: 13px; color: var(--text);
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}
.block-time {
  color: var(--accent); font-weight: 700; font-size: 12px; white-space: nowrap;
}
.block-route-bottom {
  display: flex; align-items: center; gap: 3px;
}
.block-arrow { color: var(--text-light); font-size: 10px; flex-shrink: 0; }
.block-to {
  color: var(--primary); font-weight: 700; font-size: 13px;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}

.block-profiles {
  display: flex; flex-direction: row;
  flex-shrink: 0; align-items: center;
}
.block-profile-img {
  width: 26px; height: 26px;
  border-radius: 50%; object-fit: cover;
  border: 2px solid var(--primary);
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  margin-left: -6px;
}
.block-profile-img:first-child { margin-left: 0; }
.block-profile-img.placeholder {
  display: flex; align-items: center; justify-content: center;
  font-size: 11px; font-weight: 600;
}

.block-delete {
  position: absolute; top: 2px; right: 3px;
  background: none; border: none;
  color: var(--text-light); font-size: 12px;
  cursor: pointer; padding: 2px; line-height: 1; opacity: 0.3;
}
.block-delete:hover { opacity: 1; color: #e57373; }

/* Add button */
.add-block-btn {
  width: 100%; padding: 6px;
  border: 1.5px dashed var(--border);
  border-radius: 8px; background: transparent;
  color: var(--text-light); font-size: 16px;
  cursor: pointer; transition: all 0.2s;
  margin-top: 2px;
}
.add-block-btn:hover {
  border-color: var(--primary); color: var(--primary);
  background: var(--primary-light);
}

/* Modal */
.modal-overlay {
  position: fixed; inset: 0;
  background: rgba(0,0,0,0.4);
  z-index: 200;
  display: flex; align-items: flex-end; justify-content: center;
  opacity: 0; visibility: hidden; transition: all 0.3s;
}
.modal-overlay.active { opacity: 1; visibility: visible; }
.modal {
  background: white; width: 100%; max-width: 480px;
  border-radius: 20px 20px 0 0; padding: 0;
  transform: translateY(100%);
  transition: transform 0.3s cubic-bezier(0.32, 0.72, 0, 1);
  max-height: 90vh; overflow-y: auto;
}
.modal-overlay.active .modal { transform: translateY(0); }
.modal-handle { width: 36px; height: 4px; background: var(--border); border-radius: 2px; margin: 10px auto; }
.modal-header {
  padding: 12px 20px 16px; border-bottom: 1px solid var(--border);
  display: flex; align-items: center; justify-content: space-between;
}
.modal-header h2 { font-size: 17px; font-weight: 600; }
.modal-close {
  background: var(--bg); border: none;
  width: 30px; height: 30px; border-radius: 50%;
  font-size: 16px; cursor: pointer; color: var(--text-light);
  display: flex; align-items: center; justify-content: center;
}
.modal-body { padding: 20px; }

/* Form */
.form-group { margin-bottom: 18px; }
.form-label { display: block; font-size: 13px; font-weight: 600; color: var(--text-light); margin-bottom: 8px; }
.form-row { display: flex; gap: 8px; align-items: center; }
.form-input, .form-select {
  width: 100%; padding: 12px 14px;
  border: 1.5px solid var(--border); border-radius: 10px;
  font-size: 15px; color: var(--text); background: var(--bg);
  outline: none; transition: border-color 0.2s; -webkit-appearance: none;
}
.form-input:focus, .form-select:focus { border-color: var(--primary); }
.form-select {
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%238a8a8a' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10z'/%3E%3C/svg%3E");
  background-repeat: no-repeat; background-position: right 12px center; padding-right: 32px;
}
.form-arrow { font-size: 20px; color: var(--text-light); flex-shrink: 0; }

.child-selector { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 8px; }
.child-chip {
  display: flex; align-items: center; gap: 6px;
  padding: 6px 12px 6px 6px; border: 1.5px solid var(--border);
  border-radius: 20px; background: white; cursor: pointer;
  transition: all 0.2s; font-size: 13px;
}
.child-chip.selected { border-color: var(--primary); background: var(--primary-light); }
.child-chip-img { width: 26px; height: 26px; border-radius: 50%; object-fit: cover; background: var(--bg); }
.child-chip-img.placeholder-chip {
  display: flex; align-items: center; justify-content: center;
  font-size: 12px; font-weight: 600; color: var(--primary); background: var(--primary-light);
}
.add-child-btn {
  display: flex; align-items: center; gap: 4px;
  padding: 6px 14px; border: 1.5px dashed var(--border);
  border-radius: 20px; background: transparent; cursor: pointer;
  font-size: 13px; color: var(--text-light); transition: all 0.2s;
}
.add-child-btn:hover { border-color: var(--primary); color: var(--primary); }

.day-toggles { display: flex; gap: 6px; flex-wrap: wrap; }
.day-toggle {
  padding: 8px 0; border: 1.5px solid var(--border);
  border-radius: 10px; background: white; cursor: pointer;
  font-size: 13px; font-weight: 500; color: var(--text-light);
  transition: all 0.2s; flex: 1; text-align: center; min-width: 40px;
}
.day-toggle.selected { border-color: var(--primary); background: var(--primary); color: white; }

.btn-submit {
  width: 100%; padding: 14px; border: none; border-radius: 12px;
  background: linear-gradient(135deg, var(--primary), #6b8fa3);
  color: white; font-size: 16px; font-weight: 600;
  cursor: pointer; transition: transform 0.1s; margin-top: 8px;
}
.btn-submit:active { transform: scale(0.98); }

/* Child Modal */
.child-form-avatar { display: flex; flex-direction: column; align-items: center; margin-bottom: 20px; }
.child-avatar-preview {
  width: 80px; height: 80px; border-radius: 50%;
  background: var(--primary-light);
  display: flex; align-items: center; justify-content: center;
  font-size: 32px; color: var(--primary); cursor: pointer;
  overflow: hidden; border: 3px solid white;
  box-shadow: 0 2px 12px rgba(124,158,178,0.2);
  position: relative; margin-bottom: 8px;
}
.child-avatar-preview img { width: 100%; height: 100%; object-fit: cover; }
.child-avatar-preview .camera-icon {
  position: absolute; bottom: 0; right: 0;
  background: var(--primary); color: white;
  width: 24px; height: 24px; border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-size: 12px; border: 2px solid white;
}
.child-avatar-hint { font-size: 12px; color: var(--text-light); }
#childImageInput { display: none; }

/* Crop Modal */
.crop-overlay {
  position: fixed; inset: 0; z-index: 250;
  background: #000; display: none;
  flex-direction: column;
}
.crop-overlay.active { display: flex; }
.crop-header {
  display: flex; justify-content: space-between; align-items: center;
  padding: 12px 16px; color: white; flex-shrink: 0;
}
.crop-header button {
  background: none; border: none; color: white;
  font-size: 15px; font-weight: 500; padding: 8px 12px;
  cursor: pointer; border-radius: 8px;
}
.crop-header .crop-confirm {
  background: var(--primary); font-weight: 600;
}
.crop-area {
  flex: 1; position: relative; overflow: hidden;
  touch-action: none; user-select: none; -webkit-user-select: none;
}
.crop-image {
  position: absolute;
  transform-origin: 0 0;
  will-change: transform;
}
.crop-circle-mask {
  position: absolute; top: 50%; left: 50%;
  transform: translate(-50%, -50%);
  width: 240px; height: 240px;
  border-radius: 50%;
  box-shadow: 0 0 0 9999px rgba(0,0,0,0.55);
  border: 2px solid rgba(255,255,255,0.5);
  pointer-events: none; z-index: 1;
}
.crop-hint {
  text-align: center; color: rgba(255,255,255,0.5);
  font-size: 12px; padding: 8px; flex-shrink: 0;
}

.children-list { margin-top: 16px; }
.children-list-item {
  display: flex; align-items: center; gap: 10px;
  padding: 10px; border-radius: 10px; background: var(--bg); margin-bottom: 8px;
}
.children-list-item img, .children-list-item .list-avatar-placeholder {
  width: 36px; height: 36px; border-radius: 50%; object-fit: cover;
}
.list-avatar-placeholder {
  background: var(--primary-light);
  display: flex; align-items: center; justify-content: center;
  font-size: 14px; font-weight: 600; color: var(--primary);
}
.children-list-item .child-name { flex: 1; font-size: 14px; font-weight: 500; }
.children-list-item .child-delete-btn {
  background: none; border: none; color: var(--text-light);
  font-size: 16px; cursor: pointer; padding: 4px;
}
.children-list-item .child-delete-btn:hover { color: #e57373; }

.toast {
  position: fixed; bottom: 20px; left: 50%;
  transform: translateX(-50%) translateY(80px);
  background: var(--text); color: white;
  padding: 12px 20px; border-radius: 10px;
  font-size: 14px; z-index: 300;
  transition: transform 0.3s cubic-bezier(0.32, 0.72, 0, 1);
  white-space: nowrap;
}
.toast.show { transform: translateX(-50%) translateY(0); }

.time-select-wrap { display: flex; gap: 4px; align-items: center; }
.time-select-wrap .form-select { width: auto; min-width: 70px; }
.time-colon { font-size: 16px; font-weight: 600; color: var(--text-light); }

@media (max-width: 480px) {
  .schedule-container { padding: 4px 2px; }
  .schedule-block { padding: 8px 6px; }
}
</style>
</head>
<body>

<div class="app-header" style="position:relative;">
  <h1>ÌïòÏõê ÌîΩÏóÖ Ïä§ÏºÄÏ§ÑÎü¨</h1>
  <button class="header-export-btn" id="exportBtn" onclick="exportScheduleImage()" title="Ïù¥ÎØ∏ÏßÄ Ï†ÄÏû•">
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
      <polyline points="7 10 12 15 17 10"/>
      <line x1="12" y1="15" x2="12" y2="3"/>
    </svg>
  </button>
</div>

<div class="schedule-container">
  <div class="schedule-columns" id="scheduleColumns"></div>
</div>

<!-- Schedule Modal -->
<div class="modal-overlay" id="scheduleModal">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-header">
      <h2 id="scheduleModalTitle">ÏùºÏ†ï Ï∂îÍ∞Ä</h2>
      <button class="modal-close" onclick="closeScheduleModal()">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label">ÏûêÎÖÄ ÏÑ†ÌÉù</label>
        <div class="child-selector" id="childSelector"></div>
        <button class="add-child-btn" onclick="closeScheduleModal(); openChildModal();">
          <span>+</span> ÏûêÎÖÄ Ï∂îÍ∞Ä
        </button>
      </div>
      <div class="form-group">
        <label class="form-label">Ï∂úÎ∞úÏßÄ / ÏãúÍ∞Ñ / ÎèÑÏ∞©ÏßÄ</label>
        <div class="form-row">
          <input class="form-input" id="schedFrom" placeholder="Ï∂úÎ∞úÏßÄ" style="flex:1.2">
          <div class="time-select-wrap">
            <select class="form-select" id="schedHour" style="min-width:60px"></select>
            <span class="time-colon">:</span>
            <select class="form-select" id="schedMin" style="min-width:60px"></select>
          </div>
        </div>
        <div style="text-align:center; margin:6px 0;">
          <span class="form-arrow">‚Üì</span>
        </div>
        <input class="form-input" id="schedTo" placeholder="ÎèÑÏ∞©ÏßÄ">
      </div>
      <div class="form-group">
        <label class="form-label">ÏöîÏùº ÏÑ†ÌÉù</label>
        <div class="day-toggles" id="dayToggles">
          <button class="day-toggle" data-day="0">Ïõî</button>
          <button class="day-toggle" data-day="1">Ìôî</button>
          <button class="day-toggle" data-day="2">Ïàò</button>
          <button class="day-toggle" data-day="3">Î™©</button>
          <button class="day-toggle" data-day="4">Í∏à</button>
          <button class="day-toggle" data-day="5">ÌÜ†</button>
          <button class="day-toggle" data-day="6">Ïùº</button>
        </div>
      </div>
      <button class="btn-submit" id="scheduleSubmitBtn" onclick="saveSchedule()">ÏùºÏ†ï Ï∂îÍ∞Ä</button>
    </div>
  </div>
</div>

<!-- Child Modal -->
<div class="modal-overlay" id="childModal">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-header">
      <h2>ÏûêÎÖÄ Îì±Î°ù</h2>
      <button class="modal-close" onclick="closeChildModal()">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="child-form-avatar">
        <div class="child-avatar-preview" id="childAvatarPreview" onclick="document.getElementById('childImageInput').click()">
          <span>üì∑</span>
          <div class="camera-icon">‚úé</div>
        </div>
        <span class="child-avatar-hint">ÌÉ≠ÌïòÏó¨ ÏÇ¨ÏßÑ ÏÑ†ÌÉù</span>
        <input type="file" id="childImageInput" accept="image/*" onchange="previewChildImage(event)">
      </div>
      <div class="form-group">
        <label class="form-label">Ïù¥Î¶Ñ</label>
        <input class="form-input" id="childName" placeholder="ÏûêÎÖÄ Ïù¥Î¶Ñ">
      </div>
      <button class="btn-submit" onclick="saveChild()">Îì±Î°ùÌïòÍ∏∞</button>
    </div>
  </div>
</div>

<!-- Children Manager Modal -->
<div class="modal-overlay" id="childrenManagerModal">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-header">
      <h2>ÏûêÎÖÄ Í¥ÄÎ¶¨</h2>
      <button class="modal-close" onclick="closeChildrenManager()">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="children-list" id="childrenManagerList"></div>
      <button class="btn-submit" onclick="closeChildrenManager(); openChildModal();" style="margin-top:16px;">+ ÏûêÎÖÄ Ï∂îÍ∞Ä</button>
    </div>
  </div>
</div>

<!-- Crop Modal -->
<div class="crop-overlay" id="cropModal">
  <div class="crop-header">
    <button onclick="closeCropModal()">Ï∑®ÏÜå</button>
    <span style="color:white;font-weight:600;">ÏÇ¨ÏßÑ ÏûêÎ•¥Í∏∞</span>
    <button class="crop-confirm" onclick="confirmCrop()">ÏôÑÎ£å</button>
  </div>
  <div class="crop-area" id="cropArea">
    <img class="crop-image" id="cropImage">
    <div class="crop-circle-mask" id="cropCircle"></div>
  </div>
  <div class="crop-hint">ÎìúÎûòÍ∑∏ÌïòÏó¨ Ïù¥Îèô ¬∑ Îëê ÏÜêÍ∞ÄÎùΩÏúºÎ°ú ÌôïÎåÄ/Ï∂ïÏÜå</div>
</div>

<div class="toast" id="toast"></div>

<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
<script>
let children = JSON.parse(localStorage.getItem('pickup_children') || '[]');
let schedules = JSON.parse(localStorage.getItem('pickup_schedules') || '[]');
let editingScheduleId = null;
let childImageData = null;

const DAY_NAMES = ['Ïõî', 'Ìôî', 'Ïàò', 'Î™©', 'Í∏à', 'ÌÜ†', 'Ïùº'];
const CHILD_COLORS = ['#7c9eb2', '#e8a87c', '#a3c4bc', '#c4a3c4', '#c4c4a3', '#d4a5a5', '#a5b8d4'];

function initTimeSelects() {
  const h = document.getElementById('schedHour');
  const m = document.getElementById('schedMin');
  h.innerHTML = ''; m.innerHTML = '';
  for (let i = 0; i < 24; i++) { const o = document.createElement('option'); o.value = i; o.textContent = String(i).padStart(2,'0'); h.appendChild(o); }
  for (let i = 0; i < 60; i += 5) { const o = document.createElement('option'); o.value = i; o.textContent = String(i).padStart(2,'0'); m.appendChild(o); }
  h.value = 15; m.value = 0;
}

function saveData() {
  try {
    localStorage.setItem('pickup_children', JSON.stringify(children));
    localStorage.setItem('pickup_schedules', JSON.stringify(schedules));
  } catch (e) {
    showToast('Ï†ÄÏû• Í≥µÍ∞ÑÏù¥ Î∂ÄÏ°±Ìï©ÎãàÎã§. ÏÇ¨ÏßÑ ÌÅ¨Í∏∞Î•º Ï§ÑÏó¨Ï£ºÏÑ∏Ïöî.');
    return false;
  }
  return true;
}

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg; t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2000);
}

// --- Modals ---
function openScheduleModal(scheduleId) {
  editingScheduleId = scheduleId || null;
  renderChildSelector();

  if (editingScheduleId) {
    const s = schedules.find(x => x.id === editingScheduleId);
    if (s) {
      document.getElementById('scheduleModalTitle').textContent = 'ÏùºÏ†ï ÏàòÏ†ï';
      document.getElementById('scheduleSubmitBtn').textContent = 'ÏàòÏ†ïÌïòÍ∏∞';
      document.getElementById('schedFrom').value = s.from;
      document.getElementById('schedTo').value = s.to;
      document.getElementById('schedHour').value = s.hour;
      document.getElementById('schedMin').value = s.min;
      document.querySelectorAll('.child-chip').forEach(c => c.classList.toggle('selected', s.childIds.includes(c.dataset.childId)));
      document.querySelectorAll('.day-toggle').forEach(b => b.classList.toggle('selected', s.days.includes(parseInt(b.dataset.day))));
    }
  } else {
    document.getElementById('scheduleModalTitle').textContent = 'ÏùºÏ†ï Ï∂îÍ∞Ä';
    document.getElementById('scheduleSubmitBtn').textContent = 'ÏùºÏ†ï Ï∂îÍ∞Ä';
    document.getElementById('schedFrom').value = '';
    document.getElementById('schedTo').value = '';
    document.getElementById('schedHour').value = 15;
    document.getElementById('schedMin').value = 0;
    document.querySelectorAll('.child-chip').forEach(c => c.classList.remove('selected'));
    document.querySelectorAll('.day-toggle').forEach(b => b.classList.remove('selected'));
  }
  document.getElementById('scheduleModal').classList.add('active');
}

function closeScheduleModal() { document.getElementById('scheduleModal').classList.remove('active'); editingScheduleId = null; }

function openChildModal() {
  document.getElementById('childName').value = '';
  childImageData = null;
  document.getElementById('childAvatarPreview').innerHTML = '<span>üì∑</span><div class="camera-icon">‚úé</div>';
  document.getElementById('childModal').classList.add('active');
}
function closeChildModal() { document.getElementById('childModal').classList.remove('active'); }

function openChildrenManager() { renderChildrenManager(); document.getElementById('childrenManagerModal').classList.add('active'); }
function closeChildrenManager() { document.getElementById('childrenManagerModal').classList.remove('active'); }

document.querySelectorAll('.modal-overlay').forEach(o => {
  o.addEventListener('click', e => { if (e.target === o) { o.classList.remove('active'); editingScheduleId = null; } });
});

// --- Image Crop ---
const CROP_SIZE = 240;
let cropImg, cropScale, cropMinScale, cropTx, cropTy;
let cropDragging = false, cropStartX, cropStartY, cropStartTx, cropStartTy;
let cropPinchDist = 0, cropPinchScale = 1;

function previewChildImage(e) {
  const file = e.target.files[0]; if (!file) return;
  e.target.value = '';
  const img = document.getElementById('cropImage');
  const url = URL.createObjectURL(file);
  img.onload = () => {
    URL.revokeObjectURL(url);
    openCropModal(img);
  };
  img.src = url;
}

function openCropModal(img) {
  cropImg = img;
  const area = document.getElementById('cropArea');
  document.getElementById('cropModal').classList.add('active');

  requestAnimationFrame(() => {
    const aw = area.clientWidth, ah = area.clientHeight;
    cropMinScale = CROP_SIZE / Math.min(img.naturalWidth, img.naturalHeight);
    cropScale = cropMinScale;
    cropTx = (aw - img.naturalWidth * cropScale) / 2;
    cropTy = (ah - img.naturalHeight * cropScale) / 2;
    applyCropTransform();
  });
}

function closeCropModal() {
  document.getElementById('cropModal').classList.remove('active');
}

function applyCropTransform() {
  cropImg.style.transform = `translate(${cropTx}px, ${cropTy}px) scale(${cropScale})`;
}

function clampCropPosition() {
  const area = document.getElementById('cropArea');
  const aw = area.clientWidth, ah = area.clientHeight;
  const iw = cropImg.naturalWidth * cropScale, ih = cropImg.naturalHeight * cropScale;
  const cx = aw / 2, cy = ah / 2, r = CROP_SIZE / 2;

  // Image must cover the crop circle
  const minX = cx + r - iw;
  const maxX = cx - r;
  const minY = cy + r - ih;
  const maxY = cy - r;
  cropTx = Math.min(maxX, Math.max(minX, cropTx));
  cropTy = Math.min(maxY, Math.max(minY, cropTy));
}

function confirmCrop() {
  const area = document.getElementById('cropArea');
  const aw = area.clientWidth, ah = area.clientHeight;
  const cx = aw / 2, cy = ah / 2, r = CROP_SIZE / 2;

  // Crop region in natural image coordinates
  const sx = (cx - r - cropTx) / cropScale;
  const sy = (cy - r - cropTy) / cropScale;
  const sSize = CROP_SIZE / cropScale;

  const canvas = document.createElement('canvas');
  const outSize = 160;
  canvas.width = outSize; canvas.height = outSize;
  const ctx = canvas.getContext('2d');

  ctx.beginPath();
  ctx.arc(outSize / 2, outSize / 2, outSize / 2, 0, Math.PI * 2);
  ctx.closePath();
  ctx.clip();
  ctx.drawImage(cropImg, sx, sy, sSize, sSize, 0, 0, outSize, outSize);

  childImageData = canvas.toDataURL('image/jpeg', 0.8);
  document.getElementById('childAvatarPreview').innerHTML = `<img src="${childImageData}" alt=""><div class="camera-icon">‚úé</div>`;
  closeCropModal();
}

// Crop touch/mouse events
(function() {
  const area = document.getElementById('cropArea');

  // Mouse
  area.addEventListener('mousedown', e => {
    cropDragging = true;
    cropStartX = e.clientX; cropStartY = e.clientY;
    cropStartTx = cropTx; cropStartTy = cropTy;
  });
  window.addEventListener('mousemove', e => {
    if (!cropDragging) return;
    cropTx = cropStartTx + (e.clientX - cropStartX);
    cropTy = cropStartTy + (e.clientY - cropStartY);
    clampCropPosition();
    applyCropTransform();
  });
  window.addEventListener('mouseup', () => { cropDragging = false; });

  // Mouse wheel zoom
  area.addEventListener('wheel', e => {
    e.preventDefault();
    const rect = area.getBoundingClientRect();
    const mx = e.clientX - rect.left, my = e.clientY - rect.top;
    const oldScale = cropScale;
    cropScale *= e.deltaY < 0 ? 1.08 : 0.92;
    cropScale = Math.max(cropMinScale, Math.min(cropScale, cropMinScale * 5));
    cropTx = mx - (mx - cropTx) * (cropScale / oldScale);
    cropTy = my - (my - cropTy) * (cropScale / oldScale);
    clampCropPosition();
    applyCropTransform();
  }, { passive: false });

  // Touch
  area.addEventListener('touchstart', e => {
    if (e.touches.length === 1) {
      cropDragging = true;
      cropStartX = e.touches[0].clientX; cropStartY = e.touches[0].clientY;
      cropStartTx = cropTx; cropStartTy = cropTy;
    } else if (e.touches.length === 2) {
      cropDragging = false;
      cropPinchDist = Math.hypot(
        e.touches[1].clientX - e.touches[0].clientX,
        e.touches[1].clientY - e.touches[0].clientY
      );
      cropPinchScale = cropScale;
    }
  }, { passive: true });

  area.addEventListener('touchmove', e => {
    e.preventDefault();
    if (e.touches.length === 1 && cropDragging) {
      cropTx = cropStartTx + (e.touches[0].clientX - cropStartX);
      cropTy = cropStartTy + (e.touches[0].clientY - cropStartY);
      clampCropPosition();
      applyCropTransform();
    } else if (e.touches.length === 2) {
      const dist = Math.hypot(
        e.touches[1].clientX - e.touches[0].clientX,
        e.touches[1].clientY - e.touches[0].clientY
      );
      const rect = area.getBoundingClientRect();
      const mx = (e.touches[0].clientX + e.touches[1].clientX) / 2 - rect.left;
      const my = (e.touches[0].clientY + e.touches[1].clientY) / 2 - rect.top;
      const oldScale = cropScale;
      cropScale = cropPinchScale * (dist / cropPinchDist);
      cropScale = Math.max(cropMinScale, Math.min(cropScale, cropMinScale * 5));
      cropTx = mx - (mx - cropTx) * (cropScale / oldScale);
      cropTy = my - (my - cropTy) * (cropScale / oldScale);
      clampCropPosition();
      applyCropTransform();
    }
  }, { passive: false });

  area.addEventListener('touchend', () => { cropDragging = false; });
})();

function saveChild() {
  const name = document.getElementById('childName').value.trim();
  if (!name) { showToast('Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•Ìï¥ Ï£ºÏÑ∏Ïöî.'); return; }
  const newChild = { id: 'c_' + Date.now(), name, image: childImageData, color: CHILD_COLORS[children.length % CHILD_COLORS.length] };
  children.push(newChild);
  if (!saveData()) { children.pop(); return; }
  closeChildModal();
  showToast(`${name} Îì±Î°ù ÏôÑÎ£å!`); renderGrid();
}

function renderChildSelector() {
  const c = document.getElementById('childSelector'); c.innerHTML = '';
  children.forEach(child => {
    const chip = document.createElement('div');
    chip.className = 'child-chip'; chip.dataset.childId = child.id;
    chip.onclick = () => chip.classList.toggle('selected');
    chip.innerHTML = child.image
      ? `<img class="child-chip-img" src="${child.image}" alt="${child.name}"> ${child.name}`
      : `<div class="child-chip-img placeholder-chip">${child.name[0]}</div> ${child.name}`;
    c.appendChild(chip);
  });
}

function renderChildrenManager() {
  const list = document.getElementById('childrenManagerList');
  if (!children.length) { list.innerHTML = '<p style="text-align:center;color:var(--text-light);padding:20px;">Îì±Î°ùÎêú ÏûêÎÖÄÍ∞Ä ÏóÜÏäµÎãàÎã§.</p>'; return; }
  list.innerHTML = '';
  children.forEach(child => {
    const item = document.createElement('div'); item.className = 'children-list-item';
    const av = child.image ? `<img src="${child.image}" alt="">` : `<div class="list-avatar-placeholder">${child.name[0]}</div>`;
    item.innerHTML = `${av}<span class="child-name">${child.name}</span><button class="child-delete-btn" onclick="deleteChild('${child.id}')">‚úï</button>`;
    list.appendChild(item);
  });
}

function deleteChild(id) {
  const c = children.find(x => x.id === id);
  if (!confirm(`"${c.name}"ÏùÑ(Î•º) ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?`)) return;
  children = children.filter(x => x.id !== id);
  schedules.forEach(s => { s.childIds = s.childIds.filter(cid => cid !== id); });
  saveData(); renderChildrenManager(); renderGrid(); showToast('ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.');
}

document.querySelectorAll('.day-toggle').forEach(b => b.addEventListener('click', () => b.classList.toggle('selected')));

// --- Schedules ---
function saveSchedule() {
  const from = document.getElementById('schedFrom').value.trim();
  const to = document.getElementById('schedTo').value.trim();
  const hour = parseInt(document.getElementById('schedHour').value);
  const min = parseInt(document.getElementById('schedMin').value);
  const cids = [...document.querySelectorAll('.child-chip.selected')].map(c => c.dataset.childId);
  const days = [...document.querySelectorAll('.day-toggle.selected')].map(b => parseInt(b.dataset.day));

  if (!from || !to) { showToast('Ï∂úÎ∞úÏßÄÏôÄ ÎèÑÏ∞©ÏßÄÎ•º ÏûÖÎ†•Ìï¥ Ï£ºÏÑ∏Ïöî.'); return; }
  if (!days.length) { showToast('ÏöîÏùºÏùÑ ÏÑ†ÌÉùÌï¥ Ï£ºÏÑ∏Ïöî.'); return; }

  if (editingScheduleId) {
    const idx = schedules.findIndex(s => s.id === editingScheduleId);
    const backup = idx >= 0 ? { ...schedules[idx] } : null;
    if (idx >= 0) schedules[idx] = { ...schedules[idx], from, to, hour, min, childIds: cids, days };
    if (!saveData()) { if (backup && idx >= 0) schedules[idx] = backup; return; }
    showToast('ÏùºÏ†ïÏù¥ ÏàòÏ†ïÎêòÏóàÏäµÎãàÎã§.');
  } else {
    schedules.push({ id: 's_' + Date.now(), from, to, hour, min, childIds: cids, days, order: schedules.length });
    if (!saveData()) { schedules.pop(); return; }
    showToast('ÏùºÏ†ïÏù¥ Ï∂îÍ∞ÄÎêòÏóàÏäµÎãàÎã§.');
  }
  closeScheduleModal(); renderGrid();
}

function deleteSchedule(id) {
  schedules = schedules.filter(s => s.id !== id);
  saveData(); renderGrid(); showToast('ÏùºÏ†ïÏù¥ ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.');
}

function getVisibleDays() {
  const d = [0,1,2,3,4];
  if (schedules.some(s => s.days.includes(5))) d.push(5);
  if (schedules.some(s => s.days.includes(6))) d.push(6);
  return d;
}

// --- Render (Column-based) ---
function renderGrid() {
  const container = document.getElementById('scheduleColumns');
  container.innerHTML = '';

  const visibleDays = getVisibleDays();
  container.style.gridTemplateColumns = `repeat(${visibleDays.length}, 1fr)`;

  const sorted = [...schedules].sort((a, b) => (a.order ?? 0) - (b.order ?? 0));

  visibleDays.forEach(dayIdx => {
    const col = document.createElement('div');
    col.className = 'day-column';

    // Header
    const header = document.createElement('div');
    header.className = 'day-header';
    header.textContent = DAY_NAMES[dayIdx];
    col.appendChild(header);

    // Body: only schedules that include this day
    const body = document.createElement('div');
    body.className = 'day-body';
    body.dataset.day = dayIdx;

    const daySchedules = sorted.filter(s => s.days.includes(dayIdx));
    daySchedules.forEach(schedule => {
      body.appendChild(createScheduleBlock(schedule, dayIdx));
    });

    // Add button
    const addBtn = document.createElement('button');
    addBtn.className = 'add-block-btn';
    addBtn.textContent = '+';
    addBtn.onclick = () => openScheduleModal();
    body.appendChild(addBtn);

    // Drop zone for the column body
    body.addEventListener('dragover', e => { e.preventDefault(); body.classList.add('drag-over'); });
    body.addEventListener('dragleave', e => {
      if (!body.contains(e.relatedTarget)) body.classList.remove('drag-over');
    });
    body.addEventListener('drop', e => {
      e.preventDefault();
      body.classList.remove('drag-over');
    });

    col.appendChild(body);
    container.appendChild(col);
  });

  updateExportBtn();

  // Show empty hint if no schedules at all
  if (!schedules.length) {
    const empty = document.createElement('div');
    empty.className = 'empty-state';
    empty.innerHTML = `
      <svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
        <rect x="10" y="20" width="80" height="60" rx="8" stroke="#7c9eb2" stroke-width="3"/>
        <line x1="30" y1="20" x2="30" y2="80" stroke="#7c9eb2" stroke-width="2" stroke-dasharray="4 4"/>
        <line x1="50" y1="20" x2="50" y2="80" stroke="#7c9eb2" stroke-width="2" stroke-dasharray="4 4"/>
        <line x1="70" y1="20" x2="70" y2="80" stroke="#7c9eb2" stroke-width="2" stroke-dasharray="4 4"/>
        <circle cx="50" cy="50" r="12" stroke="#e8a87c" stroke-width="2.5"/>
        <line x1="50" y1="42" x2="50" y2="58" stroke="#e8a87c" stroke-width="2.5"/>
        <line x1="42" y1="50" x2="58" y2="50" stroke="#e8a87c" stroke-width="2.5"/>
      </svg>
      <p>ÏïÑÏßÅ Îì±Î°ùÎêú ÏùºÏ†ïÏù¥ ÏóÜÏñ¥Ïöî.<br>Í∞Å ÏöîÏùºÏùò + Î≤ÑÌäºÏúºÎ°ú ÏùºÏ†ïÏùÑ Ï∂îÍ∞ÄÌï¥ Î≥¥ÏÑ∏Ïöî.</p>`;
    container.appendChild(empty);
  }
}

function createScheduleBlock(schedule, dayIdx) {
  const block = document.createElement('div');
  block.className = 'schedule-block';
  block.draggable = true;
  block.dataset.scheduleId = schedule.id;
  block.dataset.day = dayIdx;

  // Resolve child colors
  const childColors = schedule.childIds
    .map(cid => children.find(c => c.id === cid))
    .filter(Boolean)
    .map(c => c.color);
  const defaultColor = '#7c9eb2';

  // Color bar (left stripe with gradient segments)
  const colorBar = document.createElement('div');
  colorBar.className = 'block-color-bar';
  if (childColors.length === 0) {
    colorBar.style.background = defaultColor;
  } else if (childColors.length === 1) {
    colorBar.style.background = childColors[0];
  } else {
    const stops = childColors.map((c, i) => {
      const start = (i / childColors.length) * 100;
      const end = ((i + 1) / childColors.length) * 100;
      return `${c} ${start}%, ${c} ${end}%`;
    }).join(', ');
    colorBar.style.background = `linear-gradient(to bottom, ${stops})`;
  }

  // Block background
  if (childColors.length <= 1) {
    block.style.background = (childColors[0] || defaultColor) + '15';
  } else {
    block.style.background = `linear-gradient(135deg, ${childColors[0]}18, ${childColors[1]}18)`;
  }

  const timeStr = `${String(schedule.hour).padStart(2,'0')}:${String(schedule.min).padStart(2,'0')}`;

  const route = document.createElement('div');
  route.className = 'block-route';
  route.innerHTML = `
    <div class="block-route-top"><span class="block-from">${schedule.from}</span> <span class="block-time">${timeStr}</span></div>
    <div class="block-route-bottom"><span class="block-arrow">‚Üí</span> <span class="block-to">${schedule.to}</span></div>`;

  const profiles = document.createElement('div');
  profiles.className = 'block-profiles';
  schedule.childIds.forEach(cid => {
    const child = children.find(c => c.id === cid);
    if (!child) return;
    if (child.image) {
      const img = document.createElement('img');
      img.className = 'block-profile-img'; img.src = child.image; img.alt = child.name;
      img.style.borderColor = child.color;
      profiles.appendChild(img);
    } else {
      const d = document.createElement('div');
      d.className = 'block-profile-img placeholder'; d.textContent = child.name[0];
      d.style.borderColor = child.color;
      d.style.background = child.color + '25';
      d.style.color = child.color;
      profiles.appendChild(d);
    }
  });

  const del = document.createElement('button');
  del.className = 'block-delete'; del.textContent = '‚úï';
  del.onclick = e => { e.stopPropagation(); deleteSchedule(schedule.id); };

  block.appendChild(colorBar);
  block.appendChild(del);
  block.appendChild(route);
  if (schedule.childIds.length > 0) block.appendChild(profiles);

  block.addEventListener('click', () => openScheduleModal(schedule.id));

  // --- Drag: desktop ---
  block.addEventListener('dragstart', e => {
    e.dataTransfer.setData('text/plain', JSON.stringify({ id: schedule.id, day: dayIdx }));
    block.classList.add('dragging');
  });
  block.addEventListener('dragend', () => {
    block.classList.remove('dragging');
    document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
  });

  // Drop onto a block = insert before/after
  block.addEventListener('dragover', e => { e.preventDefault(); e.stopPropagation(); });
  block.addEventListener('drop', e => {
    e.preventDefault(); e.stopPropagation();
    document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
    try {
      const data = JSON.parse(e.dataTransfer.getData('text/plain'));
      if (data.id !== schedule.id) reorderInDay(data.id, schedule.id, dayIdx);
    } catch(err) {}
  });

  // --- Touch drag ---
  let touchStartY = 0, touchClone = null, touchMoved = false;

  block.addEventListener('touchstart', e => {
    touchStartY = e.touches[0].clientY; touchMoved = false;
  }, { passive: true });

  block.addEventListener('touchmove', e => {
    if (Math.abs(e.touches[0].clientY - touchStartY) > 10) touchMoved = true;
    if (!touchMoved) return;
    e.preventDefault();
    if (!touchClone) {
      touchClone = block.cloneNode(true);
      touchClone.style.cssText = `position:fixed;z-index:999;opacity:0.8;pointer-events:none;width:${block.offsetWidth}px;transform:scale(1.05)`;
      document.body.appendChild(touchClone);
      block.classList.add('dragging');
    }
    touchClone.style.left = (e.touches[0].clientX - block.offsetWidth / 2) + 'px';
    touchClone.style.top = (e.touches[0].clientY - 30) + 'px';

    document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
    const target = document.elementFromPoint(e.touches[0].clientX, e.touches[0].clientY);
    if (target) {
      const dayBody = target.closest('.day-body');
      if (dayBody) dayBody.classList.add('drag-over');
    }
  }, { passive: false });

  block.addEventListener('touchend', e => {
    if (touchClone) { document.body.removeChild(touchClone); touchClone = null; }
    block.classList.remove('dragging');
    document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
    if (!touchMoved) return;

    const touch = e.changedTouches[0];
    const target = document.elementFromPoint(touch.clientX, touch.clientY);
    if (target) {
      const targetBlock = target.closest('.schedule-block');
      if (targetBlock && targetBlock.dataset.scheduleId !== schedule.id) {
        const targetDay = parseInt(targetBlock.dataset.day);
        reorderInDay(schedule.id, targetBlock.dataset.scheduleId, targetDay);
      }
    }
  });

  return block;
}

function reorderInDay(draggedId, targetId, dayIdx) {
  // Get schedules for this day in current order
  const daySchedules = schedules
    .filter(s => s.days.includes(dayIdx))
    .sort((a, b) => (a.order ?? 0) - (b.order ?? 0));

  const draggedIdx = daySchedules.findIndex(s => s.id === draggedId);
  const targetIdx = daySchedules.findIndex(s => s.id === targetId);
  if (draggedIdx < 0 || targetIdx < 0) return;

  // Move dragged to target position
  const [moved] = daySchedules.splice(draggedIdx, 1);
  daySchedules.splice(targetIdx, 0, moved);

  // Reassign order for all schedules in this day
  daySchedules.forEach((s, i) => {
    const real = schedules.find(x => x.id === s.id);
    if (real) real.order = i;
  });

  saveData();
  renderGrid();
}

// --- Export as image ---
function updateExportBtn() {
  const btn = document.getElementById('exportBtn');
  if (schedules.length > 0) btn.classList.add('visible');
  else btn.classList.remove('visible');
}

function exportScheduleImage() {
  const container = document.getElementById('scheduleColumns');
  const btn = document.getElementById('exportBtn');
  btn.style.pointerEvents = 'none';

  // Hide delete buttons and add-block buttons for clean export
  const delBtns = container.querySelectorAll('.block-delete');
  const addBtns = container.querySelectorAll('.add-block-btn');
  delBtns.forEach(b => b.style.display = 'none');
  addBtns.forEach(b => b.style.display = 'none');

  // Create a wrapper for export with title and padding
  const wrapper = document.createElement('div');
  wrapper.style.cssText = 'background:#f8f6f1;padding:24px 16px 20px;display:inline-block;min-width:' + container.offsetWidth + 'px;';

  const title = document.createElement('div');
  title.style.cssText = 'text-align:center;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;font-size:20px;font-weight:700;color:#4a4a4a;margin-bottom:16px;';
  title.textContent = 'ÌïòÏõê ÌîΩÏóÖ Ïä§ÏºÄÏ§ÑÎü¨';

  const clone = container.cloneNode(true);
  clone.style.cssText = container.style.cssText + ';background:white;border-radius:12px;box-shadow:0 2px 12px rgba(0,0,0,0.08);';

  // Fix sticky headers causing first block to be pushed down in clone
  clone.querySelectorAll('.day-header').forEach(h => {
    h.style.position = 'static';
  });

  wrapper.appendChild(title);
  wrapper.appendChild(clone);
  document.body.appendChild(wrapper);

  html2canvas(wrapper, {
    scale: 2,
    backgroundColor: '#f8f6f1',
    useCORS: true,
    logging: false
  }).then(canvas => {
    document.body.removeChild(wrapper);
    delBtns.forEach(b => b.style.display = '');
    addBtns.forEach(b => b.style.display = '');
    btn.style.pointerEvents = '';

    const link = document.createElement('a');
    link.download = 'ÌîΩÏóÖÏä§ÏºÄÏ§Ñ_' + new Date().toISOString().slice(0,10) + '.png';
    link.href = canvas.toDataURL('image/png');
    link.click();
    showToast('Ïù¥ÎØ∏ÏßÄÍ∞Ä Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.');
  }).catch(() => {
    document.body.removeChild(wrapper);
    delBtns.forEach(b => b.style.display = '');
    addBtns.forEach(b => b.style.display = '');
    btn.style.pointerEvents = '';
    showToast('Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ±Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
  });
}

// Init
initTimeSelects();
renderGrid();
</script>
</body>
</html>
